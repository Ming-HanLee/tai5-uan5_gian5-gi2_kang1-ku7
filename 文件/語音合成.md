# 語音合成（Speech Synthesis）
語音合成是文字轉做聲音的資訊技術，親像[iTaigi](http://itaigi.tw)、車站廣播，有聲冊攏有語音合成的應用。

若想直接使用語音合成，請看[服務文件](https://github.com/sih4sing5hong5/tai5-uan5_gian5-gi2_hok8-bu7/wiki/快速說明#直接用訓練好的語音合成)來設定自己的服務

## 合成原理
這馬時行的做法有接音合成（Corpus-based Speech Synthesis）佮模型合成（Model-based Speech Synthesis）：

### 接音合成
火車客運的廣播(花蓮站到矣)、排隊的叫號(593號請到3號櫃台)攏是用接音合成，
in的做法就是先錄需要的詞佮語句，
當欲用的時陣，才閣共in接起來。

這个做法的缺點是接音檔的所在可能聽起來無順無自然。

### 模型合成
[意傳](https://意傳.台灣)佮[工研院](http://tts.itri.org.tw)的模型就是用這種技術。
頭一步是用合成器（Vocoder）共語音訊號轉做一个一个的頻譜佮頻率，
才閣揣出音標佮頻譜的對應關係，佗一種音標會按怎唸，

這種技術的好處是輸出語音聽起來誠自然，
毋過聲音的品質比原本語料的音質較bai2一寡。
因為訓練的時，
聲音先用合成器轉做特徵，
合成的時，
特徵閣用合成器轉語音，
兩擺轉換造成音質變bai2。

### 混合模型
為著改善面頂兩種模型的缺點，
就愛用接音合成會配合模型合成。
用`模型合成`產生的頻譄佮頻率，
去音檔庫內，揀較符合的音檔，
才閣用`接音合成`佮音檔接起來。
若攏無符合的音檔，
就愛錄音增加音檔庫就好矣。

按呢做的優點是聲音品質誠好，
中國的[科大訊飛](http://www.iflytek.com/audioengine/list_4.html)就是用這種技術。

## 語料準備

### 需要
* `會講這個語言的人A`
* `會音標的人B`
* `會點語音學的人C`
* `會寫點程式的人D`

### 準備流程

1. `會語音學的人C`先瞭解這個語言的語音特性
  * 輔音、元音、聲調、重音、語調、音韻變化
2. `會音標的人B`，先準備三千句以上的音標
  * 以語句為單位
  * 越多句越好，建議到七千句
3. `會語音學的人C`先看這三千句，有沒有語音特性出現過少
  * 親像`a`出現10000次，毋過`i`只出現2000次
4. `會講這個語言的人A`去錄這三千句
  * 錄的語氣要注意。錄的語氣是唸稿，合出來的聲音就是唸稿
  * 每次錄音，設備事先先調音調成一樣
5. `會寫點程式的人D`把錄音檔和音檔拿去訓練

###偷食步

#### 閩南語
* [教育部辭典](https://github.com/sih4sing5hong5/tai5-uan5_gian5-gi2_hok8-bu7/wiki/快速說明#訓練語音合成模型)
* [信望愛台語聖經](https://bible.fhl.net/new/audio_hb.php?version=1)

#### 客家
* 教育部客語辭典
* 客委會認證教材

#### 族語
* 原住民族語言線上詞典


## 程式修改
[臺灣言語服務](https://github.com/sih4sing5hong5/tai5-uan5_gian5-gi2_hok8-bu7/wiki)目前支援閩南語、客話佮華語，若是需要加族語抑是別種語言，會使來看這段。

`服務`先用HTK佮語料對齊，才閣用`HTS`計算參數。建議先照的[訓練語音合成模型](https://github.com/sih4sing5hong5/tai5-uan5_gian5-gi2_hok8-bu7/wiki/快速說明#訓練語音合成模型)做，確定可以執行才開始看程式

### 程式準備
以[客語](https://github.com/sih4sing5hong5/tai5-uan5_gian5-gi2_hok8-bu7/blob/master/tai5uan5_gian5gi2_hok8bu7/settings.py#L138-L144)為例
```
'詔安腔': {
    '語族': '漢語',
    '音標系統': 臺灣客家話拼音,
    '字綜合標音': 客話綜合標音,
    '文本音值表': 客家話文本音值表,
    '決策樹仔': 客家話決策樹仔,
},
```
比較重要的參數：
* `音標系統`是提供予`拆文分析器`，共語句轉換做音標
* `文本音值表`，共音標轉換做實際上發音表。會使是IPA國際音標
* `決策樹仔`是提供予`HTS`，分類頻譄佮頻率

### 套件準備
```bash
sudo apt-get install -y libc6-dev-i386 linux-libc-dev gcc-multilib libx11-dev libx11-dev:i386 # HTK
sudo apt-get install csh # SPTK
sudo apt-get install libX11-dev # HTS
```

### 安裝
執行`python`，而且輸入
```python3
from 臺灣言語工具.語音合成.HTS工具.安裝HTS語音辨識程式 import 安裝HTS語音辨識程式
安裝HTS語音辨識程式.安裝htk()
安裝HTS語音辨識程式.安裝sptk()
安裝HTS語音辨識程式.安裝hts()
安裝HTS語音辨識程式.掠htsDemoScript()
```


## 演算法修改
介紹HTK佮HTS的作法

103/02/14 薛丞宏

才用隱性馬可夫模型佮分類器，
共音標當做輸入，
頻譜佮頻率當作輸出訓練隱性馬可夫模型佮分類器的參數。
等欲合聲音時，才閣照模型的特徵，
用合成器合聲音出來。


## 音檔
*聲音
 * 頻譜（音色）
 * 頻率（音懸）
* HTK會用著頻譜mfcc
* HTS會用著頻譜mgc佮頻率f0
 * 使用時攏用頻率對數（log f0, lf0）來算

## HTK訓練過程
* 準備資料
  * 音檔
  * 記錄音檔唸啥物的文本
    * 愛人工先一句一句切
    * 一句話上好莫超過十五字
頭仔先

## HTK訓練過程
* 會先統計逐个音的頻譜特徵
  * 高斯混合模型(Gaussion Mixture Model, GMM)
* 親像
  * 甲.我欲坐火車踅臺灣一hui。
  * 乙.伊上愛櫻花。
* hue1
  * 甲音檔30％～40％
  * 乙音檔80％～100％
  * 會當統計hue的頻譜高斯模型

## HTK訓練過程
* 閣提hue1佮其他的模型來切音
 * 會當得著新的時間
* hue1
 * 甲音檔26％～35％
 * 乙音檔77％～100％
 * 會當統計hue新的頻譜模型
* 按呢重估幾仔遍就會使提著粗用的模型
  * 閣會當加混合數量、參考前後音…效果會愈好

## HTS訓練過程
準備資料
音檔
記錄音檔唸啥物的文本
愛先用HTK先一音一音切
用人工切效果進步有限（政源）
一句話上好莫超過十五字
音標分類問題集
ang、ing、ong相倚
am、im、om相倚
...

## HTS訓練過程
佮HTK仝款先重估
用高斯模型，加混合效果無較好（揣無來源論文）
親像
甲.我欲坐火車踅臺灣一hui。
乙.伊上愛櫻花。
「坐火」佮「櫻花」的hue可能無仝款
-e hue、-ng hue
HTS訓練過程
所以hue愛考慮前後
統計的音標數量變三次方
逐个音標的音檔傷少
愛佮相倚的音標當做仝款做伙統計
用決策樹(Decision Tree)分類

# HTS工具介紹
102/09/06　薛丞宏

## 準備檔案
聲音檔
無wav檔頭
標籤label檔
音切好
格式愛家己訂
問題集

## ch0012310_2.lab
```
單位標籤檔
（mono　label）：
0 300000 sil
300000 800000 m
800000 2700000 uinn
2700000 3800000 k
3800000 5600000 ui
5600000 7200000 sil
```

## 問題集
```
...
QS "Si7_Ki2_Uan5_Im1"      {*-i+*,*-e+*,*-a+*}
QS "Si7_Kin1_Uan5_Im1"    {*-o+*,*-u+*}
QS "Si7_Ting2_Uan5_Im1"      {*-i+*,*-u+*}
QS "Si7_Tiong1_Uan5_Im1"    {*-e+*,*-o+*}
QS "Si7_Ke1_Uan5_Im1"      {*-a+*}
...
```
訓練後會產生決策樹
```
{*}[2].stream[1]
{
   0 Utt_Len_Ku3<=4                                     -1         -3    
  -1 Si7_Tsing7                                         -2          "mgc_s2_1" 
  -2 Si7_Uan5_Im1                                      -17         -7    
  -3 Ui3_Su5_Bue2<=2                                   -12         -4    
  -4 Si7_i_Tiong1                                       -6         -5    
```

### 原則
1. 揣一个問題
2. 予兩爿的數量差無濟
3. 兩爿的性質差上濟

## 使用決策樹
有三个聲音參數會用著決策樹
mgc、lf0、duration
範例預設有五个state，代表依時間切做五份
Mgc
有五个state，逐个state有一个stream
Lf0
有五个state
逐个state有三个stream，分別代表頻率、頻率差、頻率差之差
Duration
一个state，一个stream

## 訓練過程
```
$MKEMV = 1; # preparing environments
$HCMPV = 1; # computing a global variance
$IN_RE = 1; # initialization & reestimation　←用單位標籤先訓練模型
$MMMMF = 1; # making a monophone mmf
$ERST0 = 1; # embedded reestimation (monophone)
$MN2FL = 1; # copying monophone mmf to fullcontext one　←用單位標籤的複製到全文標籤來做
$ERST1 = 1; # embedded reestimation (fullcontext)
$CXCL1 = 1; # tree-based context clustering　←用著問題集
$ERST2 = 1; # embedded reestimation (clustered)
$UNTIE = 1; # untying the parameter sharing structure
$ERST3 = 1; # embedded reestimation (untied)
$CXCL2 = 1; # tree-based context clustering　←用著問題集
$ERST4 = 1; # embedded reestimation (re-clustered)
$FALGN = 1; # forced alignment for no-silent GV
$MCDGV = 1; # making global variance
$MKUNG = 1; # making unseen models (GV)
$MKUN1 = 1; # making unseen models (1mix)
$PGEN1 = 1; # generating speech parameter sequences (1mix)　←提供愛合的全文標籤，就會當合聲音
$WGEN1 = 1; # synthesizing waveforms (1mix)
```



\subsubsection{HTS}
\label{小節：HTS}
這方面開源軟體有HTS（HMM-based Speech Synthesis System）\cite{hts_zen2007hmm}，
伊是對HTK修改來的，
仝款用隱性馬可夫模型、高斯混合模型佮決策樹。
%合成器用SPTK
%用mgc、lf0、duration做聲音特徵，
%
%伊訓練方式，
%伊一个聲音會分做5个state\footnote{下跤講著的5狀態、三連音，攏是參數，毋是固定的}，
%逐个state有一个高斯模型，
%伊會先訓練逐个音的初步模型，
%閣來訓練三連音模型，
%閣用決策樹共相倚的音綁做伙。
%
%合的時陣才閣查決策樹，
%共mgc、lf0、duration查出來，
%閣用合成器合語音出來。
%莫用GV


%伊需要音檔，標記發音內容的音檔，閣有音類的問題集。設計標仔。
%標仔的時間會使對HTK訓練。
%根據經驗，3000句會使，5000句普通，7000句上好。


